基于对 `cgview-js` 现有项目的理解，以及当前前端技术发展趋势，为您制定一份针对 **UI 重构与功能升级** 的详细功能表设计及技术调研方案。

---

# CGView.js 重构计划：功能设计与技术调研

## 1. 项目现状与重构目标
*   **现状痛点**：
    *   **渲染性能**：原生 Canvas/SVG 在处理大规模基因组数据（如长序列、高密度特征）时可能存在卡顿。
    *   **交互体验**：缩放、平移、悬停提示等交互可能不够流畅，缺乏现代生物信息学工具（如 IGV, JBrowse 2）的丝滑感。
    *   **UI/UX 陈旧**：默认样式可能较为单一，缺乏响应式设计，难以适配移动端或嵌入现代 Dashboard。
    *   **扩展性**：插件化机制可能不够完善，自定义渲染逻辑复杂。
*   **重构目标**：
    *   **高性能渲染**：支持百万级碱基对的流畅缩放与平移。
    *   **现代化 UI**：提供可定制的组件库，支持深色模式、响应式布局。
    *   **模块化架构**：核心引擎与 UI 层分离，支持插件化扩展（如新的图表类型、导出格式）。
    *   **易用性**：提供更友好的 API 和配置向导。

---

## 2. 详细功能表设计 (Functional Specification)

### 2.1 核心可视化引擎 (Core Visualization)
| 功能模块 | 功能点 | 详细描述 | 优先级 |
| :--- | :--- | :--- | :--- |
| **视图模式** | 环形/线性切换 | 支持一键在环形图和线性图之间无缝切换，保持数据状态同步。 | P0 |
| | 多视图联动 | 支持同时展示多个基因组或同一基因组的不同区域，实现联动缩放。 | P1 |
| **渲染性能** | 虚拟滚动/LOD | 实现 Level of Detail (LOD) 技术，远距离只显示概览，近距离渲染细节；支持虚拟滚动以处理超长序列。 | P0 |
| | WebGL 加速 | 引入 WebGL (通过 PixiJS 或 Three.js) 替代纯 Canvas 2D，提升大量图形元素的渲染帧率。 | P0 |
| **交互操作** | 平滑缩放平移 | 惯性滑动、鼠标滚轮缩放、双指触控缩放（移动端）。 | P0 |
| | 区域选择 | 框选特定区域进行放大、导出或执行分析操作。 | P1 |
| | 搜索与定位 | 支持通过基因名、坐标快速定位并高亮显示。 | P0 |

### 2.2 数据层与解析 (Data & Parsing)
| 功能模块 | 功能点 | 详细描述 | 优先级 |
| :--- | :--- | :--- | :--- |
| **格式支持** | 原生格式增强 | 优化内部 JSON 数据结构，支持增量加载。 | P0 |
| | 标准格式解析 | 内置或插件化支持 GenBank, EMBL, GFF3, BED, BigWig (需后端代理或 WASM)。 | P0 |
| **数据管理** | 轨道管理 (Tracks) | 类似 IGV 的轨道管理器，支持添加、删除、隐藏、调整轨道顺序和高度。 | P1 |
| | 动态数据加载 | 支持按需加载远程数据块，避免一次性加载大文件。 | P1 |

### 2.3 现代化 UI 组件系统 (UI System)
| 功能模块 | 功能点 | 详细描述 | 优先级 |
| :--- | :--- | :--- | :--- |
| **控制面板** | 可折叠侧边栏 | 包含图层控制、颜色配置、显示选项，支持拖拽调整大小。 | P1 |
| | 上下文菜单 | 右键点击特征或区域，弹出操作菜单（查看详情、复制序列、BLAST 等）。 | P1 |
| ** tooltips** | 富信息提示框 | 悬停显示详细信息，支持 HTML 内容、图片预览、外部链接。 | P0 |
| **主题系统** | 预设主题 | 提供 Light, Dark, High Contrast 等预设主题。 | P1 |
| | 自定义配色 | 允许用户自定义轨道颜色、背景色、网格线样式。 | P2 |
| **导出功能** | 高清导出 | 支持导出 SVG (矢量), PNG (高分辨率), PDF 格式。 | P1 |
| | 会话保存 | 保存当前视图状态（缩放级别、位置、显隐轨道）为 JSON，支持恢复。 | P2 |

### 2.4 开发者体验 (DX)
| 功能模块 | 功能点 | 详细描述 | 优先级 |
| :--- | :--- | :--- | :--- |
| **API 设计** | Promise/Async | 所有异步操作（加载、解析）基于 Promise。 | P0 |
| | 事件系统 | 完善的事件监听（zoom, pan, click, hover, dataLoaded）。 | P0 |
| **插件机制** | 生命周期钩子 | 提供 `beforeRender`, `afterDataLoad` 等钩子供插件介入。 | P1 |
| **TypeScript** | 类型定义 | 全面重写为 TypeScript，提供完整的 `.d.ts` 类型定义文件。 | P0 |

---

## 3. 技术调研与选型建议 (Technical Research)

### 3.1 渲染引擎选型 (Rendering Engine)
这是重构的核心，直接决定性能上限。

| 方案 | 技术栈 | 优势 | 劣势 | 推荐度 |
| :--- | :--- | :--- | :--- | :--- |
| **方案 A: PixiJS** | WebGL 2D 渲染器 | **极高性能**，专为 2D 图形设计，API 简单，社区成熟，适合大量 Sprite/图形绘制。 | 3D 支持较弱（本项目不需要），文本渲染需额外配置。 | ⭐⭐⭐⭐⭐ (首选) |
| **方案 B: Konva.js** | Canvas 封装 | API 友好，对象模型清晰，易于上手。 | 底层仍主要依赖 Canvas 2D (虽有 WebGL 实验版)，超大数据量下性能不如纯 WebGL。 | ⭐⭐⭐ |
| **方案 C: D3.js + Canvas** | 数据驱动文档 | 生态最强，计算能力强。 | 主要是计算库，渲染需手写 Canvas/WebGL 代码，开发成本高，性能优化需手动调优。 | ⭐⭐ |
| **方案 D: Three.js** | WebGL 3D | 功能最强大。 | 对于 2D 基因组图谱来说过于沉重，学习曲线陡峭，正交相机配置繁琐。 | ⭐ |

**结论**：建议使用 **PixiJS** 作为底层渲染引擎。它能轻松处理数万个图形元素，且支持自定义 Shader（可用于特殊的热图或密度图渲染）。

### 3.2 前端框架与架构 (Framework & Architecture)
*   **核心库框架**：**Vanilla JS + TypeScript**。
    *   *理由*：CGView.js 是一个底层可视化库，不应强依赖 React/Vue/Angular，以保持轻量级和框架无关性（Framework Agnostic）。用户可以在任何框架中调用它。
*   **构建工具**：**Vite + Rollup**。
    *   *理由*：Vite 提供极速的开发体验（HMR），Rollup 用于生成高质量的 Tree-shaking 生产包（UMD, ESM, CJS）。
*   **状态管理**：**Zustand** 或 **Proxy-based 自研轻量状态**。
    *   *理由*：不需要 Redux 那么重，只需管理视图状态（缩放、平移、轨道列表）和数据缓存。

### 3.3 数据处理与解析 (Data Processing)
*   **大文件解析**：**Web Workers**。
    *   *理由*：将 GenBank/GFF3 的解析过程放入 Worker 线程，避免阻塞主 UI 线程导致页面假死。
*   **二进制格式支持**：**WebAssembly (WASM)**。
    *   *理由*：如果需要支持 BigWig, BAM 等二进制格式，使用 Rust 或 C++ 编写解析逻辑并编译为 WASM，性能比纯 JS 快 10-50 倍。
*   **空间索引**：**R-Tree** 或 **Interval Tree**。
    *   *理由*：用于快速查询特定可视区域内的基因特征，实现 O(log n) 的查询速度，支撑快速缩放。

### 3.4 UI 组件库 (Optional Wrapper)
虽然核心库是框架无关的，但可以提供一套官方推荐的 UI 包装器：
*   **React Component**: `@cgview/react`
*   **Vue Component**: `@cgview/vue`
*   **样式方案**: **Tailwind CSS** (用于示例项目和文档) + **CSS Variables** (用于核心库的主题定制)。

---

## 4. 实施路线图 (Roadmap)

### 第一阶段：原型验证 (POC) - 4 周
*   搭建 TypeScript + Vite + PixiJS 环境。
*   实现核心的“环形”和“线性”渲染器原型。
*   验证 100kb+ 序列下的缩放和平移帧率（目标 > 50fps）。
*   实现基础的 Web Worker 解析器。

### 第二阶段：核心重构 - 8 周
*   完成所有核心渲染逻辑迁移至 PixiJS。
*   实现 LOD (多细节层次) 策略。
*   重构数据结构，引入 Interval Tree 索引。
*   完成 TypeScript 类型定义。
*   实现基础交互（缩放、平移、Hover）。

### 第三阶段：UI 与功能完善 - 6 周
*   开发轨道管理器 UI 组件。
*   实现富文本 Tooltip 和上下文菜单。
*   添加导出功能 (SVG/PNG)。
*   完善主题系统 (CSS Variables)。
*   编写详细的 API 文档和 Migration Guide。

### 第四阶段：测试与发布 - 4 周
*   单元测试 (Vitest) 与 端到端测试 (Playwright)。
*   性能基准测试 (Benchmark)。
*   Beta 版本发布，收集社区反馈。
*   正式发布 v2.0。

## 5. 潜在风险与应对
*   **风险**：WebGL 在某些老旧浏览器或特定显卡驱动上兼容性问题。
    *   *应对*：提供 Canvas 2D 降级方案（Fallback），当检测到 WebGL 不支持时自动切换。
*   **风险**：旧版 API 迁移成本高，用户抵触。
    *   *应对*：提供 `legacy-adapter` 包，尽可能兼容旧版配置项；提供详细的代码迁移脚本或指南。
*   **风险**：超大基因组（如人类染色体）内存溢出。
    *   *应对*：严格实施数据分片加载（Tile-based loading），只渲染视口内的数据，不将所有数据载入内存。

这份方案旨在将 CGView.js 从一个简单的绘图库升级为**企业级、高性能的生物基因组可视化引擎**，同时保持其易用性和灵活性。